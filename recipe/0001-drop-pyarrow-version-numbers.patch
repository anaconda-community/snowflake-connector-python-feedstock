From 75897e8fd7b504fabcf6101c3f70e86697062938 Mon Sep 17 00:00:00 2001
From: Benjamin Zaitlen <quasiben@gmail.com>
Date: Wed, 8 Mar 2023 13:42:31 -0800
Subject: drop pyarrow versions, build with proper ABI settings, and handle
 alternate location for libarrow_python

---
 setup.py | 43 +++++++++++++++++++++++++------------------
 1 file changed, 25 insertions(+), 18 deletions(-)

diff --git a/setup.py b/setup.py
index 0933604..8972f9e 100644
--- a/setup.py
+++ b/setup.py
@@ -72,16 +72,16 @@ if _ABLE_TO_COMPILE_EXTENSIONS:
         # upgraded
         arrow_libs_to_copy = {
             "linux": [
-                "libarrow.so.1000",
-                "libarrow_dataset.so.1000",
-                "libarrow_python.so.1000",
-                "libparquet.so.1000",
+                "libarrow.so",
+                "libarrow_dataset.so",
+                "libarrow_python.so",
+                "libparquet.so",
             ],
             "darwin": [
-                "libarrow.1000.dylib",
-                "libarrow_dataset.1000.dylib",
-                "libarrow_python.1000.dylib",
-                "libparquet.1000.dylib",
+                "libarrow.dylib",
+                "libarrow_dataset.dylib",
+                "libarrow_python.dylib",
+                "libparquet.dylib",
             ],
             "win32": [
                 "arrow.dll",
@@ -93,16 +93,16 @@ if _ABLE_TO_COMPILE_EXTENSIONS:
 
         arrow_libs_to_link = {
             "linux": [
-                "libarrow.so.1000",
-                "libarrow_dataset.so.1000",
-                "libarrow_python.so.1000",
-                "libparquet.so.1000",
+                "libarrow.so",
+                "libarrow_dataset.so",
+                "libarrow_python.so",
+                "libparquet.so",
             ],
             "darwin": [
-                "libarrow.1000.dylib",
-                "libarrow_dataset.1000.dylib",
-                "libarrow_python.1000.dylib",
-                "libparquet.1000.dylib",
+                "libarrow.dylib",
+                "libarrow_dataset.dylib",
+                "libarrow_python.dylib",
+                "libparquet.dylib",
             ],
             "win32": [
                 "arrow.lib",
@@ -157,7 +157,7 @@ if _ABLE_TO_COMPILE_EXTENSIONS:
                     ext.extra_compile_args.append("-isystem" + numpy.get_include())
                     if "std=" not in os.environ.get("CXXFLAGS", ""):
                         ext.extra_compile_args.append("-std=c++17")
-                        ext.extra_compile_args.append("-D_GLIBCXX_USE_CXX11_ABI=0")
+                        ext.extra_compile_args.append("-D_GLIBCXX_USE_CXX11_ABI=1")
                     if sys.platform == "darwin":
                         ext.extra_compile_args.append("-mmacosx-version-min=10.13")
 
@@ -199,7 +199,14 @@ if _ABLE_TO_COMPILE_EXTENSIONS:
 
             for lib in link_lib:
                 source = f"{self._get_arrow_lib_dir()}/{lib}"
-                assert os.path.exists(source)
+                try:
+                    # libarrow_python.so via conda is installed in
+                    # site-packages/pyarrow and *not* ${PREFIX}/lib
+                    assert os.path.exists(source)
+                except AssertionError:
+                    path = pyarrow.get_library_dirs()[0]
+                    source = os.path.join(path, lib)
+                    assert os.path.exists(source)
                 ret.append(source)
 
             return ret
-- 
2.17.1

